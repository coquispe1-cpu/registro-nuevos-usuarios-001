<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de nuevos usuarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
        }

        .message-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
        }

        .success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .loading {
            background-color: #e5e7eb;
            color: #374151;
        }

        .table-container {
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-4xl mb-8">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Registro de nuevos usuarios</h1>
        <form id="user-form" class="space-y-4">
            <!-- Sección de Información Personal -->
            <h2 class="text-xl font-semibold text-gray-700">Información Personal</h2>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/2">
                    <label for="nombres" class="block text-sm font-medium text-gray-700">Nombres y Apellidos</label>
                    <input type="text" id="nombres" name="Nombres y Apellidos" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="correo" class="block text-sm font-medium text-gray-700">Correo</label>
                    <input type="email" id="correo" name="Correo Electronico" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/3">
                    <label for="dni" class="block text-sm font-medium text-gray-700">DNI</label>
                    <input type="text" id="dni" name="DNI" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="celular" class="block text-sm font-medium text-gray-700">Celular</label>
                    <input type="tel" id="celular" name="Nº Celular" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="direccion" class="block text-sm font-medium text-gray-700">Dirección Actual</label>
                    <input type="text" id="direccion" name="Direccion Actual" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Fila para Tipo de Sangre, Género y Enfermedad -->
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/3">
                    <label for="tipoSangre" class="block text-sm font-medium text-gray-700">Tipo de Sangre</label>
                    <select id="tipoSangre" name="Tipo de Sangre" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione...</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="genero" class="block text-sm font-medium text-gray-700">Género</label>
                    <select id="genero" name="Genero" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="No binario">No binario</option>
                    </select>
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="enfermedad" class="block text-sm font-medium text-gray-700">Padece alguna enfermedad?</label>
                    <select id="enfermedad" name="Padece alguna enfermedad" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione...</option>
                        <option value="Si">Sí</option>
                        <option value="No">No</option>
                    </select>
                </div>
            </div>
            
            <!-- Campo condicional para la enfermedad -->
            <div id="enfermedad-detalle-container" class="mt-4 hidden">
                <label for="detalleEnfermedad" class="block text-sm font-medium text-gray-700">¿Cuál?</label>
                <input type="text" id="detalleEnfermedad" name="Detalle de la Enfermedad" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Sección de Lugar y Fecha de Nacimiento -->
            <h2 class="text-xl font-semibold text-gray-700 pt-6">Lugar y Fecha de Nacimiento</h2>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/2">
                    <label for="lugarNacimiento" class="block text-sm font-medium text-gray-700">Lugar de Nacimiento</label>
                    <input type="text" id="lugarNacimiento" name="Lugar de Nacimiento" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="pais" class="block text-sm font-medium text-gray-700">País</label>
                    <input type="text" id="pais" name="País" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/3">
                    <label for="distrito" class="block text-sm font-medium text-gray-700">Distrito</label>
                    <input type="text" id="distrito" name="Distrito" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="provincia" class="block text-sm font-medium text-gray-700">Provincia</label>
                    <input type="text" id="provincia" name="Provincia" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <input type="text" id="departamento" name="Departamento" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/2">
                    <label for="fechaNacimiento" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                    <input type="date" id="fechaNacimiento" name="Fecha de Nacimiento" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="edad" class="block text-sm font-medium text-gray-700">Edad</label>
                    <input type="text" id="edad" name="Edad" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md" readonly>
                </div>
            </div>

            <!-- Sección de Estado Civil e Hijos -->
            <h2 class="text-xl font-semibold text-gray-700 pt-6">Estado Civil e Hijos</h2>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/2">
                    <label for="estadoCivil" class="block text-sm font-medium text-gray-700">Estado Civil</label>
                    <select id="estadoCivil" name="Estado Civil" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione...</option>
                        <option value="Soltero">Soltero</option>
                        <option value="Casado">Casado</option>
                        <option value="Viudo">Viudo</option>
                        <option value="Divorciado">Divorciado</option>
                        <option value="Conviviente">Conviviente</option>
                    </select>
                </div>
                <div id="children-section" class="w-full sm:w-1/2 space-y-4 hidden">
                    <div>
                        <label for="numHijos" class="block text-sm font-medium text-gray-700">Cantidad de Hijos</label>
                        <input type="number" id="numHijos" name="Cantidad de Hijos" min="0" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div id="children-details-container" class="space-y-4 hidden"></div>

            <!-- Sección de Tallas -->
            <h2 class="text-xl font-semibold text-gray-700 pt-6">Tallas</h2>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/3">
                    <label for="camisa" class="block text-sm font-medium text-gray-700">Talla de Camisa</label>
                    <input type="text" id="camisa" name="Talla de Camisa" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="pantalon" class="block text-sm font-medium text-gray-700">Talla de Pantalón</label>
                    <input type="text" id="pantalon" name="Talla de Pantalon" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="w-full sm:w-1/3">
                    <label for="zapato" class="block text-sm font-medium text-gray-700">Talla de Zapato</label>
                    <input type="text" id="zapato" name="Talla de Zapato" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div id="message-container" class="hidden"></div>

            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                <button type="button" id="send-button" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition ease-in-out duration-150">
                    Enviar y Registrar
                </button>
                <button type="button" id="export-button" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition ease-in-out duration-150">
                    Exportar a CSV
                </button>
                <button type="reset" id="clear-button" class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition ease-in-out duration-150">
                    Limpiar Formulario
                </button>
            </div>
        </form>
    </div>

    <!-- Contenedor para la lista de usuarios -->
    <div id="user-list-container" class="bg-white p-8 rounded-lg shadow-md w-full max-w-4xl">
        <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Usuarios Registrados</h2>
        <div class="table-container">
            <table class="w-full border-collapse">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-2 text-left">Nombres y Apellidos</th>
                        <th class="px-4 py-2 text-left">Correo Electrónico</th>
                        <th class="px-4 py-2 text-left">DNI</th>
                        <th class="px-4 py-2 text-left">Celular</th>
                        <th class="px-4 py-2 text-left">Fecha de Registro</th>
                    </tr>
                </thead>
                <tbody id="user-list-body" class="divide-y divide-gray-200">
                    <!-- Ahora los datos no se insertan porque ya no se envían a un servidor -->
                    <tr><td colspan="5" class="py-4 text-center text-gray-500">No hay usuarios registrados en este modo local.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('user-form');
        const sendButton = document.getElementById('send-button');
        const exportButton = document.getElementById('export-button');
        const messageContainer = document.getElementById('message-container');
        const fechaNacimientoInput = document.getElementById('fechaNacimiento');
        const edadInput = document.getElementById('edad');
        const estadoCivilSelect = document.getElementById('estadoCivil');
        const childrenSection = document.getElementById('children-section');
        const numHijosInput = document.getElementById('numHijos');
        const childrenDetailsContainer = document.getElementById('children-details-container');
        const enfermedadSelect = document.getElementById('enfermedad');
        const enfermedadDetalleContainer = document.getElementById('enfermedad-detalle-container');

        // Función para mostrar u ocultar el campo de detalle de enfermedad
        enfermedadSelect.addEventListener('change', () => {
            if (enfermedadSelect.value === 'Si') {
                enfermedadDetalleContainer.classList.remove('hidden');
            } else {
                enfermedadDetalleContainer.classList.add('hidden');
                document.getElementById('detalleEnfermedad').value = '';
            }
        });

        // Función para calcular la edad automáticamente
        fechaNacimientoInput.addEventListener('input', () => {
            const birthDate = new Date(fechaNacimientoInput.value);
            const today = new Date();

            if (isNaN(birthDate.getTime())) {
                edadInput.value = '';
                return;
            }

            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDifference = today.getMonth() - birthDate.getMonth();
            
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            edadInput.value = age >= 0 ? age : '';
        });

        // Función para mostrar u ocultar los campos de hijos
        estadoCivilSelect.addEventListener('change', () => {
            const selectedStatus = estadoCivilSelect.value;
            if (selectedStatus === 'Casado' || selectedStatus === 'Divorciado' || selectedStatus === 'Viudo' || selectedStatus === 'Conviviente') {
                childrenSection.classList.remove('hidden');
            } else {
                childrenSection.classList.add('hidden');
                childrenDetailsContainer.classList.add('hidden');
                numHijosInput.value = '';
                childrenDetailsContainer.innerHTML = '';
            }
        });
        
        // Función para generar los campos de nombre y sexo para cada hijo
        numHijosInput.addEventListener('input', () => {
            const numHijos = parseInt(numHijosInput.value);
            childrenDetailsContainer.innerHTML = '';
            
            if (numHijos > 0) {
                childrenDetailsContainer.classList.remove('hidden');
                for (let i = 1; i <= numHijos; i++) {
                    const childDiv = document.createElement('div');
                    childDiv.className = 'flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0';
                    childDiv.innerHTML = `
                        <div class="w-full sm:w-1/2">
                            <label for="nombreHijo${i}" class="block text-sm font-medium text-gray-700">Nombre de Hijo ${i}</label>
                            <input type="text" id="nombreHijo${i}" name="Nombre de Hijo ${i}" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="w-full sm:w-1/2">
                            <label for="sexoHijo${i}" class="block text-sm font-medium text-gray-700">Sexo de Hijo ${i}</label>
                            <select id="sexoHijo${i}" name="Sexo de Hijo ${i}" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Seleccione...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                            </select>
                        </div>
                    `;
                    childrenDetailsContainer.appendChild(childDiv);
                }
            } else {
                childrenDetailsContainer.classList.add('hidden');
            }
        });

        // Función para recopilar todos los datos del formulario
        function getFormData() {
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            data['Fecha de Registro'] = new Date().toLocaleDateString('es-ES');
            
            const numHijos = parseInt(numHijosInput.value);
            if (numHijos > 0) {
                const hijos = [];
                for (let i = 1; i <= numHijos; i++) {
                    const nombre = document.getElementById(`nombreHijo${i}`).value;
                    const sexo = document.getElementById(`sexoHijo${i}`).value;
                    hijos.push({ nombre, sexo });
                }
                data['Hijos'] = JSON.stringify(hijos);
            } else {
                data['Hijos'] = '';
            }
            
            if (enfermedadSelect.value === 'Si') {
                data['Detalle de la Enfermedad'] = document.getElementById('detalleEnfermedad').value;
            } else {
                data['Detalle de la Enfermedad'] = '';
            }

            return data;
        }

        // Función para verificar si todos los campos requeridos están llenos.
        function validateForm() {
            // Verificar los campos con el atributo 'required'
            const requiredFields = form.querySelectorAll('[required]');
            for (const field of requiredFields) {
                if (!field.value) {
                    return false;
                }
            }

            // Verificar campos condicionalmente requeridos
            if (enfermedadSelect.value === 'Si' && !document.getElementById('detalleEnfermedad').value) {
                return false;
            }

            if (estadoCivilSelect.value !== 'Soltero' && estadoCivilSelect.value !== '' && estadoCivilSelect.value !== 'Seleccione...') {
                const numHijos = parseInt(numHijosInput.value);
                if (numHijos > 0) {
                    const childrenInputs = childrenDetailsContainer.querySelectorAll('input, select');
                    for (const childField of childrenInputs) {
                        if (!childField.value) {
                            return false;
                        }
                    }
                }
            }

            return true;
        }

        // --- Funcionalidad del formulario y exportación ---

        sendButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (validateForm()) {
                messageContainer.style.display = 'block';
                messageContainer.innerHTML = '¡Registro exitoso! 🎉';
                messageContainer.className = 'success message-box';
            } else {
                messageContainer.style.display = 'block';
                messageContainer.innerHTML = 'Por favor, llena todos los campos obligatorios para continuar.';
                messageContainer.className = 'error message-box';
                form.reportValidity(); // Esto resalta los campos que faltan
            }
        });

        exportButton.addEventListener('click', function() {
            if (!validateForm()) {
                messageContainer.style.display = 'block';
                messageContainer.innerHTML = 'Por favor, llena todos los campos obligatorios para poder exportar.';
                messageContainer.className = 'error message-box';
                form.reportValidity();
                return;
            }
            const data = getFormData();
            const headers = Object.keys(data);
            const rowData = headers.map(header => {
                let value = data[header];
                if (typeof value === 'string' && value.includes(',')) {
                    return `"${value}"`;
                }
                return value;
            });
            const csvContent = `${headers.join(',')}\n${rowData.join(',')}`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "usuarios.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('clear-button').addEventListener('click', () => {
            childrenSection.classList.add('hidden');
            childrenDetailsContainer.classList.add('hidden');
            numHijosInput.value = '';
            childrenDetailsContainer.innerHTML = '';
            enfermedadDetalleContainer.classList.add('hidden');
            document.getElementById('detalleEnfermedad').value = '';
            messageContainer.classList.add('hidden');
        });
    </script>
</body>
</html>
